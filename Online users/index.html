<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上用戶狀態面板</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        /* 線上用戶面板樣式 */
        #online-users {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 250px;
            z-index: 1000;
            transition: all 0.3s;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-count {
            background: #4285f4;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .auth-section {
            position: fixed;
            top: 20px;
            left: 20px;
        }
    </style>
</head>
<body>
    <!-- 線上用戶面板 -->
    <div id="online-users">
        <div class="panel-header">
            <h3>線上用戶 (<span id="user-count">0</span>)</h3>
            <div class="user-count" id="user-count-badge">0</div>
        </div>
        <div class="user-list" id="user-list"></div>
    </div>

    <!-- 登入/登出按鈕 -->
    <div class="auth-section">
        <button id="signin-button" style="display:none;">使用 Google 登入</button>
        <button id="signout-button" style="display:none;">登出</button>
    </div>

<script>
// Firebase 配置（使用您提供的配置）
const firebaseConfig = {
    apiKey: "AIzaSyDt9mJRH-BHlEksl4xla32sVIUGVnLUxWY",
    authDomain: "future-infusion-368721.firebaseapp.com",
    projectId: "future-infusion-368721",
    storageBucket: "future-infusion-368721.appspot.com",
    messagingSenderId: "345445420847",
    appId: "1:345445420847:web:070778c173ec6157c6dbda",
    measurementId: "G-57PJMMNNWW"
};

// 初始化 Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// 線上狀態管理
const presenceRef = database.ref('presence');
const connectedRef = database.ref('.info/connected');

// DOM 元素
const userList = document.getElementById('user-list');
const userCount = document.getElementById('user-count');
const userCountBadge = document.getElementById('user-count-badge');
const signinButton = document.getElementById('signin-button');
const signoutButton = document.getElementById('signout-button');

// 用戶狀態處理
let currentUserRef = null;

// 監聽認證狀態變化
auth.onAuthStateChanged(user => {
    if (user) {
        handleSignedInUser(user);
        signinButton.style.display = 'none';
        signoutButton.style.display = 'block';
    } else {
        handleSignedOutUser();
        signinButton.style.display = 'block';
        signoutButton.style.display = 'none';
    }
});

// Google 登入處理
signinButton.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
};

// 登出處理
signoutButton.onclick = () => auth.signOut();

// 更新線上狀態
function setupPresence(user) {
    const userRef = presenceRef.child(user.uid);
    
    connectedRef.on('value', snap => {
        if (snap.val() === true) {
            currentUserRef = userRef;
            
            // 設置用戶狀態
            userRef.set({
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                lastOnline: firebase.database.ServerValue.TIMESTAMP
            });
            
            // 斷線處理
            userRef.onDisconnect().update({
                lastOnline: firebase.database.ServerValue.TIMESTAMP
            });
        }
    });
}

// 渲染用戶列表
function renderUserList(snapshot) {
    userList.innerHTML = '';
    let count = 0;
    
    snapshot.forEach(childSnapshot => {
        const user = childSnapshot.val();
        if (user.lastOnline > Date.now() - 30000) { // 30秒內在線
            count++;
            const userElement = document.createElement('div');
            userElement.className = 'user-item';
            userElement.innerHTML = `
                <img src="${user.photoURL}" class="user-avatar" alt="頭像">
                <div>
                    <div>${user.displayName}</div>
                    <div style="font-size:0.8em;color:#666;">${user.email}</div>
                </div>
            `;
            userList.appendChild(userElement);
        }
    });
    
    userCount.textContent = count;
    userCountBadge.textContent = count;
}

// 初始化線上狀態監聽
presenceRef.on('value', snapshot => {
    renderUserList(snapshot);
});

// 用戶登入處理
function handleSignedInUser(user) {
    setupPresence(user);
    
    // 更新用戶資料
    database.ref('users/' + user.uid).set({
        displayName: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        lastLogin: firebase.database.ServerValue.TIMESTAMP
    });
}

// 用戶登出處理
function handleSignedOutUser() {
    if (currentUserRef) {
        currentUserRef.remove();
        currentUserRef.onDisconnect().cancel();
        currentUserRef = null;
    }
}

// 初始化UI
signoutButton.style.display = 'none';
</script>

<!-- Firebase 安全規則配置說明 -->
<!-- 
{
  "rules": {
    "presence": {
      ".read": "auth != null",
      ".write": "auth != null && auth.uid === $key"
    },
    "users": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $uid"
      }
    }
  }
}
-->
</body>
</html>