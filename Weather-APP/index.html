<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤©æ°£ç®¡å®¶AI</title>
  <style>
    /* èª¿æ•´æ•´é«”ç¶²é èƒŒæ™¯ç‚ºæ·¡ç°ç™½ï¼Œæœ‰è³ªæ„Ÿ */
    body {
      background-color: #f5f5f5;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
    }
    .container {
      max-width: 480px;
      margin: 20px auto;
      padding: 20px;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      min-height: 90vh;
    }
    .header {
      text-align: center;
      margin-bottom: 10px;
    }
    .header h1 {
      font-size: 2em;
      margin: 0;
      color: #007bff;
      animation: fadeIn 2s ease-in-out;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* AI æŒ‰éˆ•æ¨£å¼ï¼Œæ”¾åœ¨æœ€ä¸Šé¢ */
    #aiButton {
      display: block;
      margin: 10px auto 20px;
      padding: 12px 20px;
      background: linear-gradient(45deg, #007bff, #0056b3);
      border: none;
      border-radius: 25px;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #aiButton:hover {
      opacity: 0.9;
    }
    /* é¡¯ç¤ºåœ°å€æ–‡å­—æ”¹ç‚ºç™½è‰²ï¼ŒèƒŒæ™¯æ¡æ·ºé»‘è‰² */
    #locationName {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 10px;
      color: #fff;
      background-color: #444;
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
    }
    /* å¤©æ°£è³‡è¨Šå€ */
    #weatherDisplay {
      padding: 10px;
      text-align: center;
      margin-bottom: 20px;
    }
    .current-weather {
      background: #007bff;
      color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .current-weather div {
      margin: 5px 0;
    }
    .section {
      margin-bottom: 20px;
      text-align: left;
    }
    .section h2 {
      font-size: 1.1em;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .section li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.95em;
      line-height: 1.5;
    }
    /* æ‰‹å‹•è¼¸å…¥ä½ç½® */
    #locationInput {
      text-align: center;
      margin-top: 20px;
    }
    input[type="text"] {
      width: 80%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
    }
    button:active {
      background: #0056b3;
    }
    /* å…¨ç•«é¢èŠå¤©ä»‹é¢ */
    #chatModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #chatContainer {
      background: #fff;
      width: 90%;
      max-width: 480px;
      max-height: 90%;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chatHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    #chatMessages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f9f9f9;
    }
    /* ç”¨æˆ¶æ³¡æ³¡ï¼šå³å´ */
    .chat-message.user {
      align-self: flex-end;
      background: #DCF8C6;
      padding: 10px;
      border-radius: 12px;
      max-width: 70%;
      word-break: break-word;
    }
    /* AI æ³¡æ³¡ï¼šå·¦å´ */
    .chat-message.ai {
      align-self: flex-start;
      background: #FFFFFF;
      padding: 10px;
      border-radius: 12px;
      max-width: 70%;
      word-break: break-word;
      border: 1px solid #ddd;
    }
    #chatInputContainer {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #chatInputContainer input {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 1em;
    }
    #chatInputContainer button {
      border: none;
      background: #007bff;
      color: #fff;
      padding: 10px 20px;
      cursor: pointer;
    }
    #closeChat {
      background: #dc3545;
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      padding: 5px 10px;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    /* éŸ¿æ‡‰å¼è¨­å®šï¼šæ‰‹æ©Ÿè¢å¹• */
    @media (max-width: 600px) {
      #chatContainer {
        width: 100%;
        height: 100%;
        border-radius: 0;
        max-width: none;
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å°‡ AI æŒ‰éˆ•ç§»è‡³æœ€ä¸Šæ–¹ -->
    <button id="aiButton">AIä»Šå¤©é©åˆåšä»€éº¼äº‹</button>
    <div class="header">
      <h1>å¤©æ°£ç®¡å®¶AI</h1>
    </div>
    <!-- é¡¯ç¤ºè‡ªå‹•å–å¾—çš„åœ°å€åç¨± -->
    <div id="locationName">ç²å–åœ°å€ä¸­...</div>
    <!-- å¤©æ°£è³‡è¨Šå€ï¼Œåˆå§‹åƒ…æç¤º -->
    <div id="weatherDisplay">è«‹è¼¸å…¥ä½ç½®ä»¥å–å¾—æœ€æ–°å¤©æ°£è³‡è¨Š...</div>
    <!-- æ‰‹å‹•ä½ç½®è¼¸å…¥ä»‹é¢ -->
    <div id="locationInput" style="display: none;">
      <input type="text" id="location" placeholder="è«‹è¼¸å…¥æ‚¨çš„ä½ç½® (ä¾‹å¦‚ï¼šå°åŒ—)" />
      <br />
      <button id="submitLocation">æŸ¥è©¢</button>
    </div>
  </div>

  <!-- å…¨ç•«é¢èŠå¤©ä»‹é¢ -->
  <div id="chatModal">
    <div id="chatContainer">
      <div id="chatHeader">å¤©æ°£ç®¡å®¶AI</div>
      <div id="chatMessages"></div>
      <div id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦" />
        <button id="sendChat">é€å‡º</button>
      </div>
      <button id="closeChat">é—œé–‰</button>
    </div>
  </div>

  <script>
    // å¤©æ°£ç›¸é—œåŠŸèƒ½
    function mapPrecip(prob) {
      if (prob <= 10) return "å¤§æ™´å¤© â˜€ï¸";
      else if (prob <= 30) return "æ™´å¤© â˜€ï¸";
      else if (prob <= 50) return "å°‘é›² ğŸŒ¤ï¸";
      else if (prob <= 70) return "å¤šé›² â˜ï¸";
      else if (prob <= 80) return "å±€éƒ¨é™é›¨ ğŸŒ¦ï¸";
      else if (prob <= 90) return "é™£é›¨ ğŸŒ§ï¸";
      else return "é›¨ ğŸŒ§ï¸";
    }
    function formatHourly(ts) {
      const parts = ts.split("T");
      const dateParts = parts[0].split("-");
      const formattedDate = `${dateParts[0]}å¹´${dateParts[1]}æœˆ${dateParts[2]}è™Ÿ`;
      const timePart = parts[1];
      return { formattedDate, timePart };
    }
    function formatDate(ts) {
      const dateParts = ts.split("-");
      return `${dateParts[0]}å¹´${dateParts[1]}æœˆ${dateParts[2]}è™Ÿ`;
    }
    function getLocationDetails(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data && data.address) {
            const address = data.address;
            let locationInfo = "";
            if (address.road) locationInfo += address.road + ", ";
            if (address.suburb) locationInfo += address.suburb + ", ";
            if (address.city) locationInfo += address.city;
            else if (address.town) locationInfo += address.town;
            else if (address.village) locationInfo += address.village;
            if (address.state) locationInfo += ", " + address.state;
            if (address.country) locationInfo += ", " + address.country;
            document.getElementById("locationName").innerText = locationInfo;
          } else {
            document.getElementById("locationName").innerText = "æœªçŸ¥åœ°å€";
          }
        })
        .catch(error => {
          console.error("æŸ¥è©¢åœ°å€å¤±æ•—ï¼š", error);
          document.getElementById("locationName").innerText = "æœªçŸ¥åœ°å€";
        });
    }
    function fetchWeather(lat, lon) {
      const apiUrl =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&hourly=temperature_2m,precipitation,precipitation_probability` +
        `&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max` +
        `&current_weather=true&forecast_days=7&timezone=auto`;
      fetch(apiUrl)
        .then(response => response.json())
        .then(data => displayWeather(data))
        .catch(error => {
          document.getElementById("weatherDisplay").innerHTML =
            "<p>å–å¾—å¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>";
          console.error(error);
        });
    }
    // æ ¹æ“š API è³‡æ–™å‹•æ…‹çµ„å‡ºå¤©æ°£è³‡è¨Šå…§å®¹
    function displayWeather(data) {
      let html = "";
      const now = new Date();
      // ä½¿ç”¨æ¯å°æ™‚å¤©æ°£ä¸­èˆ‡ç›®å‰æ™‚é–“æœ€æ¥è¿‘çš„è³‡æ–™ä½œç‚ºç›®å‰å¤©æ°£
      let currentIndex = 0;
      if (data.hourly && data.hourly.time) {
        for (let i = 0; i < data.hourly.time.length; i++) {
          const forecastTime = new Date(data.hourly.time[i]);
          if (forecastTime >= now) {
            currentIndex = i;
            break;
          }
        }
      }
      const { formattedDate, timePart } = formatHourly(data.hourly.time[currentIndex]);
      const currentTemp = data.hourly.temperature_2m ? data.hourly.temperature_2m[currentIndex] : "N/A";
      const currentPrecipitation = data.hourly.precipitation ? data.hourly.precipitation[currentIndex] : "N/A";
      const currentPrecipProb = data.hourly.precipitation_probability ? data.hourly.precipitation_probability[currentIndex] : "N/A";
      const currentCondition = mapPrecip(currentPrecipProb);
      // ç›®å‰å¤©æ°£å€å¡Šï¼Œæ’ç‰ˆç¾åŒ–
      html += `<div class="current-weather">
                <div style="font-size:1.3em; font-weight:bold;">ç›®å‰å¤©æ°£</div>
                <div style="margin-top:5px;">${formattedDate} ${timePart}</div>
                <div style="margin-top:10px;">ç‹€æ…‹ï¼š${currentCondition}</div>
                <div>æº«åº¦ï¼š${currentTemp} Â°C</div>
                <div>é™é›¨é‡ï¼š${currentPrecipitation} mm</div>
                <div>é™é›¨æ©Ÿç‡ï¼š${currentPrecipProb}%</div>
              </div>`;
      // ä»Šå¤©æ¯å°æ™‚å¤©æ°£
      if (data.hourly && data.hourly.time && data.hourly.temperature_2m && data.hourly.precipitation && data.hourly.precipitation_probability) {
        html += `<div class="section">
                  <h2>ä»Šå¤©çš„æ¯å°æ™‚å¤©æ°£</h2>
                  <ul id="hourlyList">`;
        const todayStr = now.toISOString().split("T")[0];
        let count = 0;
        for (let i = 0; i < data.hourly.time.length && count < 24; i++) {
          if (!data.hourly.time[i].startsWith(todayStr)) continue;
          let forecastTime = new Date(data.hourly.time[i]);
          if (forecastTime < now) continue;
          const { formattedDate, timePart } = formatHourly(data.hourly.time[i]);
          const condition = mapPrecip(data.hourly.precipitation_probability[i]);
          html += `<li>${formattedDate} (${condition})<br>
                   æ™‚é–“ï¼š${timePart}ï¼Œæº«åº¦ï¼š${data.hourly.temperature_2m[i]} Â°C<br>
                   é™é›¨é‡ï¼š${data.hourly.precipitation[i]} mmï¼Œé™é›¨æ©Ÿç‡ï¼š${data.hourly.precipitation_probability[i]}%</li>`;
          count++;
        }
        html += `</ul></div>`;
      }
      // æ¯æ—¥é å ±ï¼ˆ7å¤©ï¼‰
      if (data.daily && data.daily.time && data.daily.temperature_2m_max && data.daily.temperature_2m_min && data.daily.sunrise && data.daily.sunset && data.daily.precipitation_probability_max) {
        html += `<div class="section">
                  <h2>æ¯æ—¥é å ± (7å¤©)</h2>
                  <ul>`;
        for (let i = 0; i < data.daily.time.length; i++) {
          const conditionDaily = mapPrecip(data.daily.precipitation_probability_max[i]);
          const sunriseTime = data.daily.sunrise[i].split("T")[1];
          const sunsetTime = data.daily.sunset[i].split("T")[1];
          html += `<li>${formatDate(data.daily.time[i])} (${conditionDaily})<br>
                   æº«åº¦æœ€é«˜ï¼š${data.daily.temperature_2m_max[i]} Â°Cï¼Œæº«åº¦æœ€ä½ï¼š${data.daily.temperature_2m_min[i]} Â°C<br>
                   æ—¥å‡ºï¼š${sunriseTime}ï¼Œæ—¥è½ï¼š${sunsetTime}ï¼Œé™é›¨æ©Ÿç‡ï¼š${data.daily.precipitation_probability_max[i]}%</li>`;
        }
        html += `</ul></div>`;
      }
      document.getElementById("weatherDisplay").innerHTML = html;
    }
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          getLocationDetails(lat, lon);
          fetchWeather(lat, lon);
        },
        (error) => {
          document.getElementById("weatherDisplay").innerHTML =
            "<p>ç„¡æ³•è‡ªå‹•å–å¾—æ‚¨çš„ä½ç½®ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚</p>";
          document.getElementById("locationInput").style.display = "block";
          console.error(error);
        }
      );
    } else {
      document.getElementById("weatherDisplay").innerHTML =
        "<p>æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•å®šä½ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚</p>";
      document.getElementById("locationInput").style.display = "block";
    }
    document.getElementById("submitLocation").addEventListener("click", () => {
      const location = document.getElementById("location").value;
      if (!location) {
        alert("è«‹è¼¸å…¥ä½ç½®ï¼");
        return;
      }
      fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`)
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            const lat = data.results[0].latitude;
            const lon = data.results[0].longitude;
            const locationName = (data.results[0].admin1 ? data.results[0].admin1 : data.results[0].name) + (data.results[0].admin2 ? " " + data.results[0].admin2 : "");
            document.getElementById("locationName").innerText = locationName;
            fetchWeather(lat, lon);
          } else {
            document.getElementById("weatherDisplay").innerHTML =
              "<p>æ‰¾ä¸åˆ°è©²ä½ç½®ï¼Œè«‹å˜—è©¦å…¶ä»–ä½ç½®ã€‚</p>";
          }
        })
        .catch(error => {
          document.getElementById("weatherDisplay").innerHTML =
            "<p>è½‰æ›ä½ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>";
          console.error(error);
        });
    });

    // èŠå¤©åŠŸèƒ½ï¼ˆèˆ‡å…ˆå‰ç‰ˆæœ¬é¡ä¼¼ï¼‰
    let chatHistory = [];
    document.getElementById("aiButton").addEventListener("click", () => {
      const weatherContext = document.getElementById("weatherDisplay").innerText || "ç„¡å¤©æ°£è³‡è¨Š";
      chatHistory = [{
        role: "system",
        content: "ä½ æ˜¯ä¸€å€‹å¤©æ°£ç®¡å®¶AI ä½ ç¾åœ¨è¦å¹«å®¢æˆ¶å›ç­”å®ƒçš„å•é¡Œ é€™æ˜¯å¤©æ°£è³‡è¨Š\n" + weatherContext
      }];
      document.getElementById("chatMessages").innerHTML = "";
      document.getElementById("chatModal").style.display = "flex";
    });
    document.getElementById("sendChat").addEventListener("click", async () => {
      const sendButton = document.getElementById("sendChat");
      sendButton.disabled = true;
      const input = document.getElementById("chatInput");
      const userMessage = input.value.trim();
      if (!userMessage) {
        sendButton.disabled = false;
        return;
      }
      // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯ï¼ˆå³å´ï¼‰
      appendMessage("user", userMessage);
      chatHistory.push({ role: "user", content: userMessage });
      // åŠ å…¥æš«æ™‚ AI æ³¡æ³¡ï¼Œé¡¯ç¤ºã€Œ(æ€è€ƒä¸­)ã€
      const aiBubble = document.createElement("div");
      aiBubble.className = "chat-message ai";
      aiBubble.innerText = "(æ€è€ƒä¸­)";
      aiBubble.id = "aiTemp";
      document.getElementById("chatMessages").appendChild(aiBubble);
      input.value = "";
      try {
        const response = await fetch("https://api.suanli.cn/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer sk-W0rpStc95T7JVYVwDYc29IyirjtpPPby6SozFMQr17m8KWeo",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "free:QwQ-32B",
            messages: chatHistory
          })
        });
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        const data = await response.json();
        const aiReply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content 
          ? data.choices[0].message.content 
          : "æŠ±æ­‰ï¼Œç„¡æ³•å–å¾—å›è¦†ã€‚";
        chatHistory.push({ role: "assistant", content: aiReply });
        document.getElementById("aiTemp").innerText = aiReply;
      } catch (error) {
        console.error("AI å›è¦†éŒ¯èª¤ï¼š", error);
        document.getElementById("aiTemp").innerText = "å–å¾—å›è¦†æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
      } finally {
        sendButton.disabled = false;
      }
    });
    function appendMessage(role, text) {
      const messageDiv = document.createElement("div");
      messageDiv.className = "chat-message " + role;
      messageDiv.innerText = text;
      document.getElementById("chatMessages").appendChild(messageDiv);
      document.getElementById("chatMessages").scrollTop = document.getElementById("chatMessages").scrollHeight;
    }
    document.getElementById("closeChat").addEventListener("click", () => {
      document.getElementById("chatModal").style.display = "none";
      document.getElementById("chatMessages").innerHTML = "";
      document.getElementById("chatInput").value = "";
      chatHistory = [];
    });
  </script>
</body>
</html>
