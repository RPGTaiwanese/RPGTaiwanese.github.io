<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>巴哈勇者大亂鬥</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getDatabase, ref, set, get, onValue, update, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const config = {
      apiKey: "AIzaSyDt9mJRH-BHlEksl4xla32sVIUGVnLUxWY",
      authDomain: "future-infusion-368721.firebaseapp.com",
      databaseURL: "https://future-infusion-368721-default-rtdb.firebaseio.com",
      projectId: "future-infusion-368721",
      storageBucket: "future-infusion-368721.firebasestorage.app",
      messagingSenderId: "345445420847",
      appId: "1:345445420847:web:070778c173ec6157c6dbda",
      measurementId: "G-57PJMMNNWW"
    };

    const app = initializeApp(config);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth();
    let currentBahamutAccount = "", currentAvatarUrl = "", currentLevel = 1, currentHP = 300, duelOpponent = null, duelRoomRef = null, isInDuel = false;
    const moves = ["嫩 Damage 20 Reply 0 Effect 0", "好喔 Damage 10 Reply 0 Effect 0", "太弱了 Damage 15 Reply 5 Effect 0", "你輸了 Damage 25 Reply 0 Effect 0"];

    function getRandomMove() {
      return moves[Math.floor(Math.random() * moves.length)];
    }

    function parseMove(t) {
      let a = t.split(" ");
      return { text: a[0], damage: parseInt(a[2]), reply: parseInt(a[4]), effect: parseInt(a[6]) };
    }

    // 登入並取得玩家資料，採用 get() 一次性讀取
    window.loginWithBahamutAccount = function () {
      let u = document.getElementById('bahamut-account').value.trim();
      if (u.length < 2) { alert('請輸入至少兩個字元。'); return; }
      currentBahamutAccount = u;
      let avatarUrl = `https://avatar2.bahamut.com.tw/avataruserpic/${u.charAt(0)}/${u.charAt(1)}/${u}/${u}.png`;
      currentAvatarUrl = avatarUrl;
      const ur = ref(db, 'players/' + u);
      get(ur).then(snap => {
        let d = snap.val();
        if (d) { currentLevel = d.level; currentHP = d.hp; } else { currentLevel = 1; currentHP = 300; }
        set(ur, { bahamut: u, avatar: avatarUrl, level: currentLevel, hp: currentHP, online: true });
        onDisconnect(ur).remove();
        document.getElementById('my-account').innerText = "巴哈帳號：" + u;
        document.getElementById('my-level').innerText = "等級：" + currentLevel;
        let img = document.getElementById('my-avatar');
        img.src = avatarUrl;
        img.alt = u + "的勇者造型";
        img.style.cursor = "default";
        document.getElementById('login-area').style.display = 'none';
        document.getElementById('main-section').style.display = 'block';
        loadPlayers();
        listenDuels();
      });
    }

    function loadPlayers() {
      const pr = ref(db, 'players/');
      onValue(pr, snap => {
        const ps = snap.val(), div = document.getElementById("online-players");
        div.innerHTML = "";
        for (let k in ps) {
          let p = ps[k];
          if (!p.online || p.bahamut === currentBahamutAccount) continue;
          let c = document.createElement("div");
          c.style.display = "inline-block";
          c.style.margin = "10px";
          c.style.verticalAlign = "top";
          let l = document.createElement("p");
          l.innerText = "巴哈帳號：" + p.bahamut;
          c.appendChild(l);
          let lv = document.createElement("p");
          lv.innerText = "等級：" + p.level;
          c.appendChild(lv);
          let i = document.createElement("img");
          i.src = p.avatar;
          i.alt = p.bahamut + "的勇者造型";
          i.style.cursor = "pointer";
          i.addEventListener("click", e => { e.stopPropagation(); if (isInDuel) { alert("正在決鬥中"); return } showPlayerOptions(p, e); });
          c.appendChild(i);
          div.appendChild(c);
        }
      });
    }

    function showPlayerOptions(p, e) {
      let m = document.createElement("div");
      m.style.position = "absolute";
      m.style.backgroundColor = "#fff";
      m.style.border = "1px solid #000";
      m.style.padding = "10px";
      m.innerHTML = `<button id="duel-btn">決鬥</button>
                     <a href="https://home.gamer.com.tw/homeindex.php?owner=${p.bahamut}" target="_blank"><button>看小屋</button></a>
                     <a href="https://home.gamer.com.tw/homeindex.php?owner=${p.bahamut}" target="_blank"><button>加好友</button></a>
                     <button id="cancel-btn">取消</button>`;
      m.style.top = e.clientY + "px";
      m.style.left = e.clientX + "px";
      m.addEventListener("click", ev => { ev.stopPropagation(); });
      document.body.appendChild(m);
      function closeMenu(ev) {
        if (!m.contains(ev.target)) {
          m.remove();
          document.removeEventListener("click", closeMenu);
        }
      }
      document.addEventListener("click", closeMenu);
      m.querySelector("#duel-btn").addEventListener("click", ev => { ev.stopPropagation(); m.remove(); startDuel(p); });
      m.querySelector("#cancel-btn").addEventListener("click", ev => { ev.stopPropagation(); m.remove(); });
    }

    function startDuel(opp) {
      isInDuel = true;
      duelOpponent = opp;
      let roomId = (opp.bahamut < currentBahamutAccount) ? opp.bahamut + "_" + currentBahamutAccount : currentBahamutAccount + "_" + opp.bahamut;
      duelRoomRef = ref(db, 'duels/' + roomId);
      const ds = {
        player1: { uid: opp.bahamut, bahamut: opp.bahamut, avatar: opp.avatar, level: opp.level, hp: opp.hp },
        player2: { uid: currentBahamutAccount, bahamut: currentBahamutAccount, avatar: currentAvatarUrl, level: currentLevel, hp: currentHP },
        turn: currentBahamutAccount,
        log: []
      };
      set(duelRoomRef, ds).then(() => {
        document.getElementById("main-section").style.display = "none";
        document.getElementById("duel-section").style.display = "block";
        updateDuelUI(ds);
      });
      listenDuelUpdates(roomId);
    }

    function listenDuelUpdates(rid) {
      const rr = ref(db, 'duels/' + rid);
      onValue(rr, snap => {
        let s = snap.val();
        if (s) {
          updateDuelUI(s);
          if (s.player1.hp <= 0 || s.player2.hp <= 0) { endDuel(s); }
        }
      });
    }

    function updateDuelUI(s) {
      document.getElementById("player1-account").innerText = "巴哈帳號：" + s.player1.bahamut;
      document.getElementById("player1-level").innerText = "等級：" + s.player1.level;
      document.getElementById("player1-avatar").src = s.player1.avatar;
      document.getElementById("player1-avatar").alt = s.player1.bahamut + "的勇者造型";
      document.getElementById("player1-hp").innerText = "HP: " + s.player1.hp;
      document.getElementById("player2-account").innerText = "巴哈帳號：" + s.player2.bahamut;
      document.getElementById("player2-level").innerText = "等級：" + s.player2.level;
      document.getElementById("player2-avatar").src = s.player2.avatar;
      document.getElementById("player2-avatar").alt = s.player2.bahamut + "的勇者造型";
      document.getElementById("player2-hp").innerText = "HP: " + s.player2.hp;
      let ld = document.getElementById("duel-log");
      ld.innerHTML = "";
      (s.log || []).forEach(m => {
        let p = document.createElement("p");
        p.innerText = m;
        ld.appendChild(p);
      });
      if (s.turn === currentBahamutAccount) {
        document.getElementById("turn-indicator").innerText = "輪到你攻擊";
        showMoveOptions(false);
      } else {
        document.getElementById("turn-indicator").innerText = "等待對方攻擊";
        showMoveOptions(true);
      }
    }

    function showMoveOptions(dis) {
      let d = document.getElementById("move-options");
      d.innerHTML = "";
      for (let i = 0; i < 3; i++) {
        let t = getRandomMove();
        let b = document.createElement("button");
        b.innerText = t;
        if (dis) {
          b.disabled = true;
        } else {
          b.addEventListener("click", () => { performMove(t); });
        }
        d.appendChild(b);
      }
    }

    // 以 runTransaction 進行原子性更新，確保正確讀取與更新決鬥資料
    function performMove(t) {
      let m = parseMove(t);
      if (!duelRoomRef) return;
      runTransaction(duelRoomRef, (s) => {
        if (s && s.turn === currentBahamutAccount) {
          let a, def;
          if (s.player2.uid === currentBahamutAccount) { a = s.player2; def = s.player1; }
          else if (s.player1.uid === currentBahamutAccount) { a = s.player1; def = s.player2; }
          else return s;
          def.hp -= m.damage;
          a.hp += m.reply;
          if (!s.log) s.log = [];
          s.log.push(`${a.bahamut} 使用 "${m.text}" 造成 ${m.damage} 傷害，回復 ${m.reply} HP`);
          s.turn = (s.turn === s.player1.uid) ? s.player2.uid : s.player1.uid;
        }
        return s;
      });
    }

    function endDuel(s) {
      let r = "";
      if (s.player1.hp <= 0 && s.player2.hp <= 0) r = "平手！";
      else if (s.player1.hp <= 0) r = (s.player1.uid === currentBahamutAccount) ? "你輸了！" : "你贏了！";
      else if (s.player2.hp <= 0) r = (s.player2.uid === currentBahamutAccount) ? "你輸了！" : "你贏了！";
      alert("決鬥結束：" + r);
      document.getElementById("duel-section").style.display = "none";
      document.getElementById("main-section").style.display = "block";
      isInDuel = false;
    }

    function listenDuels() {
      const dr = ref(db, "duels/");
      onValue(dr, snap => {
        let ds = snap.val();
        if (ds) {
          for (let id in ds) {
            let d = ds[id];
            if ((d.player1.uid === currentBahamutAccount || d.player2.uid === currentBahamutAccount) && !isInDuel) {
              document.getElementById("main-section").style.display = "none";
              document.getElementById("duel-section").style.display = "block";
              updateDuelUI(d);
              listenDuelUpdates(id);
              break;
            }
          }
        }
      });
    }

    window.myAvatarClick = function () {
      if (isInDuel) { alert("正在決鬥中"); }
    };

    window.onload = function () {
      signInAnonymously(auth).then(() => {
        console.log("匿名登入成功");
        document.getElementById('login-area').style.display = 'block';
      })
      .catch(err => { console.error("匿名登入錯誤:", err); });
    };
  </script>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; }
    header { margin-bottom: 20px; }
    #online-players div { display: inline-block; margin: 10px; vertical-align: top; }
    #duel-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #eee; }
    #duel-container { display: flex; justify-content: space-around; align-items: center; height: 100%; }
    #left-player, #battle-center, #right-player { text-align: center; }
    #battle-center { border: 1px solid #000; padding: 10px; margin: 0 20px; }
    #duel-log { height: 300px; overflow-y: auto; border: 1px solid #000; margin: 20px auto; padding: 10px; background-color: #fff; width: 80%; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <header>
    <h1>巴哈勇者大亂鬥</h1>
  </header>
  <div id="login-area">
    <label for="bahamut-account">輸入巴哈帳號：</label>
    <input type="text" id="bahamut-account" name="bahamut-account">
    <button onclick="loginWithBahamutAccount()">顯示勇者造型</button>
  </div>
  <div id="main-section" style="display:none;">
    <div id="my-info">
      <p id="my-account"></p>
      <p id="my-level"></p>
      <img id="my-avatar" src="" alt="" style="max-width:200px;max-height:200px;" onclick="myAvatarClick()">
    </div>
    <h2>線上玩家</h2>
    <div id="online-players"></div>
  </div>
  <div id="duel-section" style="display:none;">
    <div id="duel-container">
      <div id="left-player">
        <p id="player1-account"></p>
        <p id="player1-level"></p>
        <img id="player1-avatar" src="" alt="">
        <div id="player1-hp"></div>
      </div>
      <div id="battle-center">
        <div id="turn-indicator" style="font-size:24px;margin:20px;"></div>
        <div id="duel-log"></div>
        <div id="move-options"></div>
      </div>
      <div id="right-player">
        <p id="player2-account"></p>
        <p id="player2-level"></p>
        <img id="player2-avatar" src="" alt="">
        <div id="player2-hp"></div>
      </div>
    </div>
  </div>
</body>
</html>
