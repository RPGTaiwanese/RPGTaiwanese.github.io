<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>巴哈勇者大亂鬥</title>
  <!-- Firebase SDK (v9 模組化版) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { 
      getDatabase, ref, set, onValue, update, onDisconnect 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyDt9mJRH-BHlEksl4xla32sVIUGVnLUxWY",
      authDomain: "future-infusion-368721.firebaseapp.com",
      databaseURL: "https://future-infusion-368721-default-rtdb.firebaseio.com",
      projectId: "future-infusion-368721",
      storageBucket: "future-infusion-368721.firebasestorage.app",
      messagingSenderId: "345445420847",
      appId: "1:345445420847:web:070778c173ec6157c6dbda",
      measurementId: "G-57PJMMNNWW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    const auth = getAuth();

    // 全域變數：Firebase 的使用者（匿名登入產生）與巴哈帳號（使用者輸入）
    let currentUser = null;         // Firebase 使用者 (匿名登入)
    let currentBahamutAccount = "";   // 使用者輸入的巴哈帳號
    let currentAvatarUrl = "";
    let currentLevel = 1;
    let currentHP = 300;            // 1等：300, 2等：350, 以此類推
    let duelOpponent = null;
    let duelRoomRef = null;
    let isInDuel = false;

    // 模擬 Confrontation.txt 中的招式
    const moves = [
      "嫩 Damage 20 Reply 0 Effect 0",
      "好喔 Damage 10 Reply 0 Effect 0",
      "太弱了 Damage 15 Reply 5 Effect 0",
      "你輸了 Damage 25 Reply 0 Effect 0"
    ];

    function getRandomMove() {
      return moves[Math.floor(Math.random() * moves.length)];
    }

    function parseMove(moveText) {
      const parts = moveText.split(" ");
      return {
        text: parts[0],
        damage: parseInt(parts[2]),
        reply: parseInt(parts[4]),
        effect: parseInt(parts[6])
      };
    }

    // 使用者輸入巴哈帳號後，按下按鈕執行
    window.loginWithBahamutAccount = function() {
      const username = document.getElementById('bahamut-account').value.trim();
      if (username.length < 2) {
        alert('請輸入至少兩個字元的帳號名稱。');
        return;
      }
      currentBahamutAccount = username;
      const firstChar = username.charAt(0);
      const secondChar = username.charAt(1);
      const avatarUrl = `https://avatar2.bahamut.com.tw/avataruserpic/${firstChar}/${secondChar}/${username}/${username}.png`;
      currentAvatarUrl = avatarUrl;

      // 從資料庫讀取該玩家資料，若無則初始化
      const userRef = ref(database, 'players/' + username);
      onValue(userRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          currentLevel = data.level;
          currentHP = data.hp;
        } else {
          currentLevel = 1;
          currentHP = 300;
        }
        // 將玩家資料寫入 Firebase，設定 online 為 true
        set(userRef, {
          bahamut: username,
          avatar: avatarUrl,
          level: currentLevel,
          hp: currentHP,
          online: true
        });
        // 當使用者離線時自動移除該資料
        onDisconnect(userRef).remove();

        // 顯示使用者自己的頭像
        const avatarImg = document.getElementById('my-avatar');
        avatarImg.src = avatarUrl;
        avatarImg.alt = `${username}的勇者造型`;
        avatarImg.style.cursor = "default";

        // 登入成功後隱藏輸入區
        document.getElementById('login-area').style.display = 'none';
        // 顯示主畫面
        document.getElementById('main-section').style.display = 'block';
        // 載入線上玩家
        loadPlayers();
      }, { onlyOnce: true });
    };

    // 讀取資料庫中線上（online 為 true）的玩家，排除自己
    function loadPlayers() {
      const playersRef = ref(database, 'players/');
      onValue(playersRef, (snapshot) => {
        const players = snapshot.val();
        const onlinePlayersDiv = document.getElementById("online-players");
        onlinePlayersDiv.innerHTML = "";
        for (let key in players) {
          const player = players[key];
          if (!player.online) continue;
          if (player.bahamut === currentBahamutAccount) continue;
          const img = document.createElement("img");
          img.src = player.avatar;
          img.alt = player.bahamut + " 的勇者造型";
          img.style.width = "100px";
          img.style.height = "100px";
          img.style.margin = "10px";
          img.style.cursor = "pointer";
          // 點擊其他玩家頭像，顯示選單（決鬥、看小屋、加好友）
          img.addEventListener("click", function(e) {
            e.stopPropagation();
            if (isInDuel) {
              alert("正在決鬥中");
              return;
            }
            showPlayerOptions(player, e);
          });
          onlinePlayersDiv.appendChild(img);
        }
      });
    }

    function showPlayerOptions(player, event) {
      const menuDiv = document.createElement("div");
      menuDiv.style.position = "absolute";
      menuDiv.style.backgroundColor = "#fff";
      menuDiv.style.border = "1px solid #000";
      menuDiv.style.padding = "10px";
      menuDiv.innerHTML = `
        <button id="duel-btn">決鬥</button>
        <a href="https://home.gamer.com.tw/homeindex.php?owner=${player.bahamut}" target="_blank"><button>看小屋</button></a>
        <a href="https://home.gamer.com.tw/homeindex.php?owner=${player.bahamut}" target="_blank"><button>加好友</button></a>
      `;
      menuDiv.style.top = event.clientY + "px";
      menuDiv.style.left = event.clientX + "px";
      menuDiv.addEventListener("click", function(e) {
        e.stopPropagation();
      });
      document.body.appendChild(menuDiv);
      function closeMenu(e) {
        if (!menuDiv.contains(e.target)) {
          menuDiv.remove();
          document.removeEventListener("click", closeMenu);
        }
      }
      document.addEventListener("click", closeMenu);
      menuDiv.querySelector("#duel-btn").addEventListener("click", function(e) {
        e.stopPropagation();
        menuDiv.remove();
        startDuel(player);
      });
    }

    function startDuel(opponent) {
      isInDuel = true;
      duelOpponent = opponent;
      let roomId = "";
      if (currentBahamutAccount < opponent.bahamut) {
        roomId = currentBahamutAccount + "_" + opponent.bahamut;
      } else {
        roomId = opponent.bahamut + "_" + currentBahamutAccount;
      }
      duelRoomRef = ref(database, 'duels/' + roomId);
      const duelState = {
        player1: {
          uid: currentBahamutAccount,
          bahamut: currentBahamutAccount,
          avatar: currentAvatarUrl,
          level: currentLevel,
          hp: currentHP
        },
        player2: {
          uid: opponent.bahamut,
          bahamut: opponent.bahamut,
          avatar: opponent.avatar,
          level: opponent.level,
          hp: opponent.hp
        },
        turn: currentBahamutAccount, // 先由發起決鬥者攻擊
        log: []
      };
      set(duelRoomRef, duelState).then(() => {
        document.getElementById("main-section").style.display = "none";
        document.getElementById("duel-section").style.display = "block";
        updateDuelUI(duelState);
        listenDuelUpdates(roomId);
      });
    }

    function listenDuelUpdates(roomId) {
      const roomRef = ref(database, 'duels/' + roomId);
      onValue(roomRef, (snapshot) => {
        const duelState = snapshot.val();
        if (duelState) {
          updateDuelUI(duelState);
          if (duelState.player1.hp <= 0 || duelState.player2.hp <= 0) {
            endDuel(duelState);
          }
        }
      });
    }

    function updateDuelUI(state) {
      document.getElementById("player1-avatar").src = state.player1.avatar;
      document.getElementById("player2-avatar").src = state.player2.avatar;
      document.getElementById("player1-hp").innerText = "HP: " + state.player1.hp;
      document.getElementById("player2-hp").innerText = "HP: " + state.player2.hp;
      const logDiv = document.getElementById("duel-log");
      logDiv.innerHTML = "";
      state.log.forEach((msg) => {
        const p = document.createElement("p");
        p.innerText = msg;
        logDiv.appendChild(p);
      });
      if (state.turn === currentBahamutAccount) {
        document.getElementById("turn-indicator").innerText = "輪到你攻擊";
        showMoveOptions();
      } else {
        document.getElementById("turn-indicator").innerText = "等待對方攻擊";
        hideMoveOptions();
      }
    }

    function showMoveOptions() {
      const movesDiv = document.getElementById("move-options");
      movesDiv.innerHTML = "";
      for (let i = 0; i < 3; i++) {
        const moveText = getRandomMove();
        const btn = document.createElement("button");
        btn.innerText = moveText;
        btn.addEventListener("click", function() {
          performMove(moveText);
        });
        movesDiv.appendChild(btn);
      }
    }

    function hideMoveOptions() {
      document.getElementById("move-options").innerHTML = "";
    }

    function performMove(moveText) {
      const move = parseMove(moveText);
      if (!duelRoomRef) return;
      onValue(duelRoomRef, (snapshot) => {
        const state = snapshot.val();
        if (!state) return;
        if (state.turn !== currentBahamutAccount) return;
        let attacker, defender;
        if (state.player1.uid === currentBahamutAccount) {
          attacker = state.player1;
          defender = state.player2;
        } else {
          attacker = state.player2;
          defender = state.player1;
        }
        defender.hp -= move.damage;
        attacker.hp += move.reply;
        state.log.push(`${attacker.bahamut} 使用 "${move.text}" 造成 ${move.damage} 傷害，回復 ${move.reply} HP`);
        state.turn = (state.turn === state.player1.uid) ? state.player2.uid : state.player1.uid;
        update(duelRoomRef, state);
      }, { onlyOnce: true });
    }

    function endDuel(state) {
      let resultMsg = "";
      if (state.player1.hp <= 0 && state.player2.hp <= 0) {
        resultMsg = "平手！";
      } else if (state.player1.hp <= 0) {
        resultMsg = (state.player1.uid === currentBahamutAccount) ? "你輸了！" : "你贏了！";
      } else if (state.player2.hp <= 0) {
        resultMsg = (state.player2.uid === currentBahamutAccount) ? "你輸了！" : "你贏了！";
      }
      alert("決鬥結束：" + resultMsg);
      document.getElementById("duel-section").style.display = "none";
      document.getElementById("main-section").style.display = "block";
      isInDuel = false;
    }

    window.myAvatarClick = function() {
      if (isInDuel) {
        alert("正在決鬥中");
      }
    };

    // 網頁載入時，先用 Firebase 匿名登入（自動登入）
    window.onload = function() {
      signInAnonymously(auth)
        .then(() => {
          console.log("Firebase anonymous login successful");
          // 顯示巴哈帳號輸入區 (login-area)
          document.getElementById('login-area').style.display = 'block';
        })
        .catch((error) => {
          console.error("Firebase anonymous login error:", error);
        });
    };
  </script>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; }
    #online-players img { border: 2px solid #000; }
    #duel-section { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background-color: #eee; 
    }
    #duel-container { margin-top: 50px; }
    #duel-log { 
      height: 150px; overflow-y: scroll; border: 1px solid #000; 
      margin: 20px; padding: 10px; background-color: #fff; 
    }
    button { margin: 5px; }
  </style>
</head>
<body>
  <!-- 登入區：使用者輸入巴哈帳號 -->
  <div id="login-area">
    <h1>巴哈勇者大亂鬥</h1>
    <label for="bahamut-account">輸入巴哈帳號：</label>
    <input type="text" id="bahamut-account" name="bahamut-account">
    <button onclick="loginWithBahamutAccount()">顯示勇者造型</button>
  </div>

  <!-- 主畫面：顯示自己的頭像與線上玩家列表 -->
  <div id="main-section" style="display:none;">
    <img id="my-avatar" src="" alt="" style="max-width:200px; max-height:200px;" onclick="myAvatarClick()">
    <h2>線上玩家</h2>
    <div id="online-players"></div>
  </div>

  <!-- 決鬥畫面 -->
  <div id="duel-section" style="display:none;">
    <div id="duel-container">
      <div>
        <img id="player1-avatar" src="" alt="" style="width:150px; height:150px;">
        <div id="player1-hp"></div>
      </div>
      <div id="turn-indicator" style="font-size:24px; margin:20px;"></div>
      <div>
        <img id="player2-avatar" src="" alt="" style="width:150px; height:150px;">
        <div id="player2-hp"></div>
      </div>
      <div id="duel-log"></div>
      <div id="move-options"></div>
    </div>
  </div>
</body>
</html>
