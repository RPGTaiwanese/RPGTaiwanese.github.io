<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>巴哈勇者大亂鬥</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const cfg = {
      apiKey: "AIzaSyDt9mJRH-BHlEksl4xla32sVIUGVnLUxWY",
      authDomain: "future-infusion-368721.firebaseapp.com",
      databaseURL: "https://future-infusion-368721-default-rtdb.firebaseio.com",
      projectId: "future-infusion-368721",
      storageBucket: "future-infusion-368721.firebasestorage.app",
      messagingSenderId: "345445420847",
      appId: "1:345445420847:web:070778c173ec6157c6dbda",
      measurementId: "G-57PJMMNNWW"
    };
    const app = initializeApp(cfg),
          db = getDatabase(app),
          auth = getAuth();

    let myID = "", myAvatar = "", myLevel = 1, myHP = 300;

    // 登入並更新 players/ 狀態
    window.login = function(){
      let u = document.getElementById("bahamut-account").value.trim();
      if(u.length < 2){
        alert("請輸入至少兩個字元。");
        return;
      }
      myID = u;
      myAvatar = `https://avatar2.bahamut.com.tw/avataruserpic/${u.charAt(0)}/${u.charAt(1)}/${u}/${u}.png`;
      const ur = ref(db, "players/" + u);
      get(ur).then(snap => {
        let d = snap.val();
        if(d){
          myLevel = d.level;
          myHP = d.hp;
        } else {
          myLevel = 1;
          myHP = 300;
        }
        set(ur, { bahamut: u, avatar: myAvatar, level: myLevel, hp: myHP, online: true });
        onDisconnect(ur).remove();
        document.getElementById("my-account").innerText = "巴哈帳號：" + u;
        document.getElementById("my-level").innerText = "等級：" + myLevel;
        document.getElementById("my-avatar").src = myAvatar;
        document.getElementById("login-area").style.display = "none";
        document.getElementById("main-section").style.display = "block";
        loadPlayers();
      });
    };

    // 載入上線玩家列表
    function loadPlayers(){
      const pr = ref(db, "players/");
      onValue(pr, snap => {
        const ps = snap.val();
        const div = document.getElementById("online-players");
        div.innerHTML = "";
        for(let k in ps){
          let p = ps[k];
          if(!p.online || p.bahamut === myID) continue;
          const c = document.createElement("div");
          c.style.display = "inline-block";
          c.style.margin = "10px";
          c.style.verticalAlign = "top";
          let l = document.createElement("p");
          l.innerText = "巴哈帳號：" + p.bahamut;
          c.appendChild(l);
          let lv = document.createElement("p");
          lv.innerText = "等級：" + p.level;
          c.appendChild(lv);
          let i = document.createElement("img");
          i.src = p.avatar;
          i.alt = p.bahamut + "的勇者造型";
          i.style.cursor = "pointer";
          i.addEventListener("click", e => {
            e.stopPropagation();
            showOpts(p, e);
          });
          c.appendChild(i);
          div.appendChild(c);
        }
      });
    }

    // 顯示對手選項：發起決鬥、看小屋、加好友等
    function showOpts(p, e){
      const m = document.createElement("div");
      m.style.position = "absolute";
      m.style.backgroundColor = "#fff";
      m.style.border = "1px solid #000";
      m.style.padding = "10px";
      m.innerHTML = `<button id="duel-btn">決鬥</button>
        <a href="https://home.gamer.com.tw/homeindex.php?owner=${p.bahamut}" target="_blank"><button>看小屋</button></a>
        <a href="https://home.gamer.com.tw/homeindex.php?owner=${p.bahamut}" target="_blank"><button>加好友</button></a>
        <button id="cancel-btn">取消</button>`;
      m.style.top = e.clientY + "px";
      m.style.left = e.clientX + "px";
      m.addEventListener("click", ev => { ev.stopPropagation(); });
      document.body.appendChild(m);
      function close(ev){
        if(!m.contains(ev.target)){
          m.remove();
          document.removeEventListener("click", close);
        }
      }
      document.addEventListener("click", close);
      m.querySelector("#duel-btn").addEventListener("click", ev => {
        ev.stopPropagation();
        m.remove();
        startDuel(p);
      });
      m.querySelector("#cancel-btn").addEventListener("click", ev => {
        ev.stopPropagation();
        m.remove();
      });
    }

    // 發起決鬥：將大廳中的決鬥動作轉交給外部的 DuelRoom.js 處理
    function startDuel(p){
      // 調用外部函式 enterDuelRoom (需由 DuelRoom.js 實作)
      if(typeof enterDuelRoom === "function"){
        enterDuelRoom(myID, myAvatar, myLevel, myHP, p);
      } else {
        alert("DuelRoom.js 尚未載入，請稍後再試。");
      }
    }
  </script>
  <!-- 引入外部決鬥房間的 JS 檔案 -->
  <script src="DuelRoom.js"></script>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; }
    header { margin-bottom: 20px; }
    #online-players div { display: inline-block; margin: 10px; vertical-align: top; }
  </style>
</head>
<body>
  <header><h1>巴哈勇者大亂鬥</h1></header>
  <div id="login-area">
    <label for="bahamut-account">輸入巴哈帳號：</label>
    <input type="text" id="bahamut-account" name="bahamut-account">
    <button onclick="login()">顯示勇者造型</button>
  </div>
  <div id="main-section" style="display:none;">
    <div id="my-info">
      <p id="my-account"></p>
      <p id="my-level"></p>
      <img id="my-avatar" src="" alt="" style="max-width:200px;max-height:200px;" onclick="alert('已登入');">
    </div>
    <h2>線上玩家</h2>
    <div id="online-players"></div>
  </div>
</body>
</html>
